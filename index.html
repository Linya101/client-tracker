      </head>
      <body>
        <div class="gold-card">
          ${createCardHTML(currentCardClient)}
        </div>
        <script>
          window.onload = function(){
            window.print();
          };
        <\/script>
      </body>
    </html>
  `;
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(cardHTML);
  w.document.close();
});

function renderTable() {
  clientTableBody.innerHTML = "";
  const term = (searchInput.value || "").toLowerCase();
  const appFilter = filterApp.value;
  const contactFilter = filterContact.value;
  const ratingFilter = parseInt(filterRating.value || "0", 10);

  clients
    .slice()
    .sort((a, b) => a.code.localeCompare(b.code))
    .forEach((c) => {
      const textBlob =
        (c.name || "") +
        " " +
        (c.state || "") +
        " " +
        (c.city || "") +
        " " +
        (c.contactHandle || "") +
        " " +
        (c.sourceApp || "") +
        " " +
        (c.hobbies || "") +
        " " +
        (c.cryptoView || "");
      if (term && !textBlob.toLowerCase().includes(term)) return;
      if (appFilter && c.sourceApp !== appFilter) return;
      if (contactFilter === "pending" && c.contacted) return;
      if (contactFilter === "contacted" && !c.contacted) return;
      if (ratingFilter && (c.rating || 0) < ratingFilter) return;

      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.innerHTML = `<span class="id-pill">${c.code}</span>`;
      tr.appendChild(tdId);

      const tdClient = document.createElement("td");
      const locationLine =
        (c.city || "") || (c.state || "")
          ? `${c.city ? c.city : ""}${c.city && c.state ? ", " : ""}${c.state ? c.state : ""}`
          : "";
      tdClient.innerHTML = `
        <div>${c.name || "-"}</div>
        <div class="small">
          ${c.age ? c.age + " yrs" : ""}${
            c.age && (c.relationshipStatus || locationLine) ? " · " : ""
          }${c.relationshipStatus || ""}${
            (c.relationshipStatus && locationLine) || (c.age && locationLine) ? " · " : ""
          }${locationLine}
        </div>
      `;
      tr.appendChild(tdClient);

      const tdProfile = document.createElement("td");
      const looking = c.lookingFor ? `<span class="chip">${c.lookingFor}</span>` : "";
      const job =
        c.jobInfo || c.workStatus
          ? `<div class="small">${c.workStatus || ""}${c.jobInfo ? " · " + c.jobInfo : ""}</div>`
          : "";
      const hobby = c.hobbies ? `<div class="small">Hobby: ${c.hobbies}</div>` : "";
      const appearance = c.appearance
        ? `<div class="small">Appearance: ${c.appearance}</div>`
        : "";
      const crypto = c.cryptoView ? `<div class="small">Crypto: ${c.cryptoView}</div>` : "";
      const asian =
        c.asianExperience === "never"
          ? `<div class="small">Asia chat: never</div>`
          : c.asianExperience === "yes"
          ? `<div class="small">Asia chat: yes</div>`
          : "";
      tdProfile.innerHTML = `${looking || ""}${job}${hobby}${appearance}${crypto}${asian}`;
      tr.appendChild(tdProfile);

      const tdContact = document.createElement("td");
      const times =
        c.workStart || c.workEnd
          ? `<div class="small">Time: ${c.workStart || "?"} - ${c.workEnd || "?"}</div>`
          : "";
      tdContact.innerHTML = `
        <div>${c.contactApp || ""}</div>
        <div class="small">${c.contactHandle || ""}</div>
        ${times}
      `;
      tr.appendChild(tdContact);

      const tdSource = document.createElement("td");
      tdSource.textContent = c.sourceApp || "";
      tr.appendChild(tdSource);

      const tdContacted = document.createElement("td");
      const btnContacted = document.createElement("button");
      btnContacted.className =
        "contacted-toggle" + (c.contacted ? " active" : "");
      btnContacted.textContent = c.contacted ? "OG contacted" : "Pending";
      btnContacted.addEventListener("click", () => {
        c.contacted = !c.contacted;
        saveAll();
        renderTable();
      });
      tdContacted.appendChild(btnContacted);
      tr.appendChild(tdContacted);

      const tdRating = document.createElement("td");
      const ratingDiv = document.createElement("div");
      ratingDiv.className = "rating";
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.textContent = "★";
        if (i <= (c.rating || 0)) star.classList.add("active");
        star.addEventListener("click", () => {
          c.rating = i;
          saveAll();
          renderTable();
        });
        ratingDiv.appendChild(star);
      }
      tdRating.appendChild(ratingDiv);
      tr.appendChild(tdRating);

      const tdActions = document.createElement("td");
      tdActions.className = "actions";
      const editBtn = document.createElement("button");
      editBtn.className = "contacted-toggle";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => {
        loadClientIntoForm(c.id);
      });
      tdActions.appendChild(editBtn);

      const cardBtn = document.createElement("button");
      cardBtn.className = "contacted-toggle";
      cardBtn.textContent = "Card";
      cardBtn.addEventListener("click", () => openCard(c));
      tdActions.appendChild(cardBtn);

      if (c.photo) {
        const img = document.createElement("img");
        img.src = c.photo;
        img.className = "photo-thumb";
        img.alt = "photo";
        tdActions.appendChild(img);
      }

      tr.appendChild(tdActions);
      clientTableBody.appendChild(tr);
    });
}

function loadClientIntoForm(id) {
  const c = findClient(id);
  if (!c) return;
  editingId = id;

  clientForm.clientName.value = c.name || "";
  clientForm.clientAge.value = c.age || "";
  clientForm.clientState.value = c.state || "";
  clientForm.clientCity.value = c.city || "";
  clientForm.relationshipStatus.value = c.relationshipStatus || "";
  clientForm.lookingFor.value = c.lookingFor || "";
  clientForm.workStatus.value = c.workStatus || "";
  workStatusSelect.dispatchEvent(new Event("change"));
  clientForm.jobInfo.value = c.jobInfo || "";
  clientForm.asianExperience.value = c.asianExperience || "";
  clientForm.cryptoView.value = c.cryptoView || "";
  clientForm.workStart.value = c.workStart || "";
  clientForm.workEnd.value = c.workEnd || "";
  clientForm.hobbies.value = c.hobbies || "";
  clientForm.appearance.value = c.appearance || "";
  clientForm.contactApp.value = c.contactApp || "";
  clientForm.contactHandle.value = c.contactHandle || "";
  clientForm.sourceApp.value = c.sourceApp || "";
  clientForm.notes.value = c.notes || "";
  photoInput.value = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

searchInput.addEventListener("input", renderTable);
filterApp.addEventListener("change", renderTable);
filterContact.addEventListener("change", renderTable);
filterRating.addEventListener("change", renderTable);

function exportCSV() {
  if (!clients.length) {
    alert("No clients to export yet.");
    return;
  }
  const header = [
    "ID","Code","Name","Age","State","City",
    "RelationshipStatus","LookingFor","WorkStatus","JobInfo",
    "AsianExperience","CryptoView","WorkStart","WorkEnd",
    "Hobbies","Appearance","ContactApp","ContactHandle",
    "SourceApp","Contacted","Rating","Notes"
  ];
  const rows = clients.map(c => [
    c.id,
    c.code,
    `"${(c.name || "").replace(/"/g,'""')}"`,
    c.age || "",
    `"${(c.state || "").replace(/"/g,'""')}"`,
    `"${(c.city || "").replace(/"/g,'""')}"`,
    `"${(c.relationshipStatus || "").replace(/"/g,'""')}"`,
    `"${(c.lookingFor || "").replace(/"/g,'""')}"`,
    `"${(c.workStatus || "").replace(/"/g,'""')}"`,
    `"${(c.jobInfo || "").replace(/"/g,'""')}"`,
    c.asianExperience || "",
    `"${(c.cryptoView || "").replace(/"/g,'""')}"`,
    c.workStart || "",
    c.workEnd || "",
    `"${(c.hobbies || "").replace(/"/g,'""')}"`,
    `"${(c.appearance || "").replace(/"/g,'""')}"`,
    c.contactApp || "",
    `"${(c.contactHandle || "").replace(/"/g,'""')}"`,
    c.sourceApp || "",
    c.contacted ? "1" : "0",
    c.rating || 0,
    `"${(c.notes || "").replace(/"/g,'""')}"`,
  ].join(","));
  const csv = header.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "og_clients.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

exportBtn.addEventListener("click", exportCSV);

saveAll();
renderTable();
updateLastSaved();
