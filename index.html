<script>
/* ---------------------------------------------------
   OG Client Tracker – FULL FIXED JAVASCRIPT
   Everything cleaned, no template literal errors
---------------------------------------------------- */

const STORAGE_KEY = "og_clients_v3";
const COUNTER_KEY = "og_client_counter_v3";
const LOGIN_FLAG = "og_logged_in_v1";

let clients = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
let counter = parseInt(localStorage.getItem(COUNTER_KEY) || "0", 10);
let editingId = null;
let currentCardClient = null;

// Elements
const loginOverlay = document.getElementById("loginOverlay");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn = document.getElementById("loginBtn");
const loginError = document.getElementById("loginError");
const appShell = document.getElementById("appShell");

const clientForm = document.getElementById("clientForm");
const clearFormBtn = document.getElementById("clearFormBtn");
const searchInput = document.getElementById("searchInput");
const filterApp = document.getElementById("filterApp");
const filterContact = document.getElementById("filterContact");
const filterRating = document.getElementById("filterRating");
const clientTableBody = document.getElementById("clientTableBody");
const clientCountMeta = document.getElementById("clientCountMeta");
const lastSavedLabel = document.getElementById("lastSavedLabel");
const workStatusSelect = document.getElementById("workStatus");
const workStatusLabel = document.getElementById("workStatusLabel");
const photoInput = document.getElementById("photo");
const exportBtn = document.getElementById("exportBtn");

// Gold card overlay
const cardOverlay = document.getElementById("clientCardOverlay");
const cardContainer = document.getElementById("clientCardContainer");
const closeCardBtn = document.getElementById("closeCardBtn");
const printCardBtn = document.getElementById("printCardBtn");

/* ---------------------------------------------------
   LOGIN
---------------------------------------------------- */
function unlockIfLogged() {
  if (localStorage.getItem(LOGIN_FLAG) === "1") {
    loginOverlay.style.display = "none";
    appShell.style.opacity = "1";
    appShell.style.pointerEvents = "auto";
  }
}

function handleLogin() {
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();

  if (u === "ogadmin" && p === "og2025") {
    localStorage.setItem(LOGIN_FLAG, "1");
    loginError.textContent = "";
    unlockIfLogged();
  } else {
    loginError.textContent = "Wrong username or password.";
  }
}

loginBtn.addEventListener("click", handleLogin);
loginPass.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleLogin();
});

unlockIfLogged();

/* ---------------------------------------------------
   STORAGE SAVE HELPERS
---------------------------------------------------- */
function saveAll() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(clients));
  localStorage.setItem(COUNTER_KEY, String(counter));
  clientCountMeta.textContent = clients.length + " clients saved";
}

function formatId(num) {
  return String(num).padStart(4, "0");
}

function findClient(id) {
  return clients.find((c) => c.id === id);
}

function updateLastSaved() {
  if (!clients.length) {
    lastSavedLabel.textContent = "";
    return;
  }
  const latest = clients.slice().sort((a, b) => (a.savedAt || 0) - (b.savedAt || 0)).at(-1);
  const d = new Date(latest.savedAt || Date.now());
  lastSavedLabel.textContent =
    "Last saved: " +
    d.toLocaleDateString() +
    " " +
    d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

/* ---------------------------------------------------
   FORM: Work Status
---------------------------------------------------- */
workStatusSelect.addEventListener("change", () => {
  const val = workStatusSelect.value;
  if (val === "retired") workStatusLabel.textContent = "Retired from";
  else if (val === "working") workStatusLabel.textContent = "Current job";
  else workStatusLabel.textContent = "Job / Retired from";
});

/* ---------------------------------------------------
   CLEAR FORM
---------------------------------------------------- */
clearFormBtn.addEventListener("click", () => {
  clientForm.reset();
  editingId = null;
});

/* ---------------------------------------------------
   FORM SUBMIT
---------------------------------------------------- */
clientForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const formData = new FormData(clientForm);
  const obj = Object.fromEntries(formData.entries());

  const clientData = {
    id: editingId || ++counter,
    code: editingId ? findClient(editingId).code : formatId(counter),
    name: obj.clientName || "",
    age: obj.clientAge || "",
    state: obj.clientState || "",
    city: obj.clientCity || "",
    relationshipStatus: obj.relationshipStatus || "",
    lookingFor: obj.lookingFor || "",
    workStatus: obj.workStatus || "",
    jobInfo: obj.jobInfo || "",
    asianExperience: obj.asianExperience || "",
    cryptoView: obj.cryptoView || "",
    workStart: obj.workStart || "",
    workEnd: obj.workEnd || "",
    hobbies: obj.hobbies || "",
    appearance: obj.appearance || "",
    contactApp: obj.contactApp || "",
    contactHandle: obj.contactHandle || "",
    sourceApp: obj.sourceApp || "",
    notes: obj.notes || "",
    contacted: editingId ? findClient(editingId).contacted : false,
    rating: editingId ? findClient(editingId).rating : 0,
    photo: editingId ? findClient(editingId).photo : "",
    savedAt: Date.now(),
  };

  const file = photoInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (evt) => {
      clientData.photo = evt.target.result || "";
      persistClient(clientData);
    };
    reader.readAsDataURL(file);
  } else {
    persistClient(clientData);
  }
});

function persistClient(clientData) {
  if (editingId) {
    const idx = clients.findIndex((c) => c.id === editingId);
    if (idx !== -1) clients[idx] = clientData;
  } else {
    clients.push(clientData);
  }
  editingId = null;
  clientForm.reset();
  photoInput.value = "";
  saveAll();
  renderTable();
  updateLastSaved();
}

/* ---------------------------------------------------
   GOLD CARD HTML
---------------------------------------------------- */
function createCardHTML(c) {
  const locationLine =
    (c.city || "") || (c.state || "")
      ? (c.city ? c.city : "") + (c.city && c.state ? ", " : "") + (c.state ? c.state : "")
      : "";

  const ratingStars = "★★★★★"
    .split("")
    .map((s, i) =>
      '<span style="color:' + (i < (c.rating || 0) ? "#d4af37" : "#4b5563") + ';">★</span>'
    )
    .join("");

  return (
    '<div class="gold-card-header">' +
    '<div>' +
    '<div class="gold-card-name">' + (c.name || "-") + '</div>' +
    '<div class="gold-card-sub">' + (locationLine || "United States") + '</div>' +
    '</div>' +
    '<div class="gold-mini-logo"><img src="og-logo.png"></div>' +
    '</div>' +

    '<div style="display:flex;justify-content:space-between;margin-bottom:4px;">' +
    '<div class="gold-card-id">OG-' + c.code + '</div>' +
    '<div style="font-size:11px;">Rating: ' + ratingStars + '</div>' +
    '</div>' +

    '<div class="gold-grid">' +
    '<div><div class="gold-label">Age</div>' + (c.age || "-") + '</div>' +
    '<div><div class="gold-label">Relationship</div>' + (c.relationshipStatus || "-") + '</div>' +
    '<div><div class="gold-label">Looking for</div>' + (c.lookingFor || "-") + '</div>' +
    '<div><div class="gold-label">Work status</div>' + 
      ((c.workStatus || "") + (c.jobInfo ? " · " + c.jobInfo : "")) +
    '</div>' +
    '<div><div class="gold-label">Crypto view</div>' + (c.cryptoView || "-") + '</div>' +
    '<div><div class="gold-label">Asia chat</div>' +
      (c.asianExperience === "never"
        ? "Never"
        : c.asianExperience === "yes"
        ? "Yes"
        : "-") +
    '</div>' +
    '<div><div class="gold-label">Work time</div>' +
      (c.workStart || "?") + " - " + (c.workEnd || "?") +
    '</div>' +
    '<div><div class="gold-label">Hobby</div>' + (c.hobbies || "-") + '</div>' +
    '</div>' +

    '<div class="gold-section"><div class="gold-section-title">Contact</div>' +
      (c.contactApp || "-") + " · " + (c.contactHandle || "") +
    '</div>' +
    '<div class="gold-section"><div class="gold-section-title">Appearance</div>' +
      (c.appearance || "-") +
    '</div>' +
    '<div class="gold-section"><div class="gold-section-title">Notes</div>' +
      (c.notes || "-") +
    '</div>'
  );
}

/* ---------------------------------------------------
   OPEN & CLOSE CARD
---------------------------------------------------- */
function openCard(c) {
  currentCardClient = c;
  cardContainer.innerHTML = createCardHTML(c);
  cardOverlay.style.display = "flex";
}

closeCardBtn.addEventListener("click", () => {
  cardOverlay.style.display = "none";
  currentCardClient = null;
});

cardOverlay.addEventListener("click", (e) => {
  if (e.target === cardOverlay) {
    cardOverlay.style.display = "none";
    currentCardClient = null;
  }
});

/* ---------------------------------------------------
   FIXED PRINT / DOWNLOAD CARD
---------------------------------------------------- */
printCardBtn.addEventListener("click", function () {
  if (!currentCardClient) return;

  var styles = document.querySelector("style").innerHTML;
  var cardInner = createCardHTML(currentCardClient);

  var cardHTML = ""
    + "<html>"
    + "<head>"
    + '<meta charset="UTF-8" />'
    + "<title>OG Card " + currentCardClient.code + "</title>"
    + "<style>"
    + "body { margin:0; background:#000; display:flex; align-items:center; justify-content:center;"
    + "min-height:100vh; font-family: system-ui, -apple-system, BlinkMacSystemFont, "
    + "'Segoe UI', sans-serif; color:#f9fafb; }"
    + ".gold-card { background: radial-gradient(circle at top, #1f2937 0, #020308 70%);"
    + "border-radius:16px; padding:14px 14px 12px; border:1px solid rgba(212,175,55,0.7);"
    + "color:#f9fafb; max-width:420px; width:100%; }"
    + styles
    + "</style>"
    + "</head>"
    + "<body>"
    + '<div class="gold-card">' + cardInner + "</div>"
    + '<script>window.onload=function(){window.print();};<\/script>'
    + "</body>"
    + "</html>";

  var w = window.open("", "_blank");
  w.document.open();
  w.document.write(cardHTML);
  w.document.close();
});

/* ---------------------------------------------------
   RENDER TABLE
---------------------------------------------------- */
function renderTable() {
  clientTableBody.innerHTML = "";
  const term = (searchInput.value || "").toLowerCase();
  const appFilter = filterApp.value;
  const contactFilter = filterContact.value;
  const ratingFilter = parseInt(filterRating.value || "0", 10);

  clients
    .slice()
    .sort((a, b) => a.code.localeCompare(b.code))
    .forEach((c) => {
      const textBlob =
        (c.name || "") +
        " " +
        (c.state || "") +
        " " +
        (c.city || "") +
        " " +
        (c.contactHandle || "") +
        " " +
        (c.sourceApp || "") +
        " " +
        (c.hobbies || "") +
        " " +
        (c.cryptoView || "");

      if (term && !textBlob.toLowerCase().includes(term)) return;
      if (appFilter && c.sourceApp !== appFilter) return;
      if (contactFilter === "pending" && c.contacted) return;
      if (contactFilter === "contacted" && !c.contacted) return;
      if (ratingFilter && (c.rating || 0) < ratingFilter) return;

      const tr = document.createElement("tr");

      const tdId = document.createElement("td");
      tdId.innerHTML = '<span class="id-pill">' + c.code + "</span>";
      tr.appendChild(tdId);

      const tdClient = document.createElement("td");
      const locationLine =
        (c.city || "") || (c.state || "")
          ? (c.city ? c.city : "") +
            (c.city && c.state ? ", " : "") +
            (c.state ? c.state : "")
          : "";

      tdClient.innerHTML =
        "<div>" +
        (c.name || "-") +
        "</div>" +
        '<div class="small">' +
        (c.age ? c.age + " yrs" : "") +
        (c.age && (c.relationshipStatus || locationLine) ? " · " : "") +
        (c.relationshipStatus || "") +
        ((c.relationshipStatus && locationLine) || (c.age && locationLine) ? " · " : "") +
        locationLine +
        "</div>";

      tr.appendChild(tdClient);

      const tdProfile = document.createElement("td");
      const looking = c.lookingFor ? '<span class="chip">' + c.lookingFor + "</span>" : "";
      const job =
        c.jobInfo || c.workStatus
          ? '<div class="small">' +
            (c.workStatus || "") +
            (c.jobInfo ? " · " + c.jobInfo : "") +
            "</div>"
          : "";
      const hobby = c.hobbies ? '<div class="small">Hobby: ' + c.hobbies + "</div>" : "";
      const appearance = c.appearance
        ? '<div class="small">Appearance: ' + c.appearance + "</div>"
        : "";
      const crypto = c.cryptoView
        ? '<div class="small">Crypto: ' + c.cryptoView + "</div>"
        : "";
      const asian =
        c.asianExperience === "never"
          ? '<div class="small">Asia chat: never</div>'
          : c.asianExperience === "yes"
          ? '<div class="small">Asia chat: yes</div>'
          : "";

      tdProfile.innerHTML = looking + job + hobby + appearance + crypto + asian;
      tr.appendChild(tdProfile);

      const tdContact = document.createElement("td");
      const times =
        c.workStart || c.workEnd
          ? '<div class="small">Time: ' + (c.workStart || "?") + " - " + (c.workEnd || "?") + "</div>"
          : "";

      tdContact.innerHTML =
        "<div>" +
        (c.contactApp || "") +
        "</div>" +
        '<div class="small">' +
        (c.contactHandle || "") +
        "</div>" +
        times;

      tr.appendChild(tdContact);

      const tdSource = document.createElement("td");
      tdSource.textContent = c.sourceApp || "";
      tr.appendChild(tdSource);

      const tdContacted = document.createElement("td");
      const btnContacted = document.createElement("button");

      btnContacted.className =
        "contacted-toggle" + (c.contacted ? " active" : "");
      btnContacted.textContent = c.contacted ? "OG contacted" : "Pending";

      btnContacted.addEventListener("click", () => {
        c.contacted = !c.contacted;
        saveAll();
        renderTable();
      });

      tdContacted.appendChild(btnContacted);
      tr.appendChild(tdContacted);

      const tdRating = document.createElement("td");
      const ratingDiv = document.createElement("div");
      ratingDiv.className = "rating";

      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.textContent = "★";
        if (i <= (c.rating || 0)) star.classList.add("active");

        star.addEventListener("click", () => {
          c.rating = i;
          saveAll();
          renderTable();
        });

        ratingDiv.appendChild(star);
      }

      tdRating.appendChild(ratingDiv);
      tr.appendChild(tdRating);

      const tdActions = document.createElement("td");
      tdActions.className = "actions";

      const editBtn = document.createElement("button");
      editBtn.className = "contacted-toggle";
      editBtn.textContent = "Edit";

      editBtn.addEventListener("click", () => {
        loadClientIntoForm(c.id);
      });

      tdActions.appendChild(editBtn);

      const cardBtn = document.createElement("button");
      cardBtn.className = "contacted-toggle";
      cardBtn.textContent = "Card";

      cardBtn.addEventListener("click", () => openCard(c));
      tdActions.appendChild(cardBtn);

      if (c.photo) {
        const img = document.createElement("img");
        img.src = c.photo;
        img.className = "photo-thumb";
        img.alt = "photo";
        tdActions.appendChild(img);
      }

      tr.appendChild(tdActions);
      clientTableBody.appendChild(tr);
    });
}

/* ---------------------------------------------------
   LOAD INTO FORM
---------------------------------------------------- */
function loadClientIntoForm(id) {
  const c = findClient(id);
  if (!c) return;

  editingId = id;

  clientForm.clientName.value = c.name || "";
  clientForm.clientAge.value = c.age || "";
  clientForm.clientState.value = c.state || "";
  clientForm.clientCity.value = c.city || "";
  clientForm.relationshipStatus.value = c.relationshipStatus || "";
  clientForm.lookingFor.value = c.lookingFor || "";
  clientForm.workStatus.value = c.workStatus || "";

  workStatusSelect.dispatchEvent(new Event("change"));

  clientForm.jobInfo.value = c.jobInfo || "";
  clientForm.asianExperience.value = c.asianExperience || "";
  clientForm.cryptoView.value = c.cryptoView || "";
  clientForm.workStart.value = c.workStart || "";
  clientForm.workEnd.value = c.workEnd || "";
  clientForm.hobbies.value = c.hobbies || "";
  clientForm.appearance.value = c.appearance || "";
  clientForm.contactApp.value = c.contactApp || "";
  clientForm.contactHandle.value = c.contactHandle || "";
  clientForm.sourceApp.value = c.sourceApp || "";
  clientForm.notes.value = c.notes || "";

  photoInput.value = "";
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* ---------------------------------------------------
   SEARCH + FILTER EVENTS
---------------------------------------------------- */
searchInput.addEventListener("input", renderTable);
filterApp.addEventListener("change", renderTable);
filterContact.addEventListener("change", renderTable);
filterRating.addEventListener("change", renderTable);

/* ---------------------------------------------------
   EXPORT CSV
---------------------------------------------------- */
function exportCSV() {
  if (!clients.length) {
    alert("No clients to export yet.");
    return;
  }

  const header = [
    "ID", "Code", "Name", "Age", "State", "City",
    "RelationshipStatus", "LookingFor", "WorkStatus", "JobInfo",
    "AsianExperience", "CryptoView", "WorkStart", "WorkEnd",
    "Hobbies", "Appearance", "ContactApp", "ContactHandle",
    "SourceApp", "Contacted", "Rating", "Notes"
  ];

  const rows = clients.map(c => [
    c.id,
    c.code,
    '"' + (c.name || "").replace(/"/g, '""') + '"',
    c.age || "",
    '"' + (c.state || "").replace(/"/g, '""') + '"',
    '"' + (c.city || "").replace(/"/g, '""') + '"',
    '"' + (c.relationshipStatus || "").replace(/"/g, '""') + '"',
    '"' + (c.lookingFor || "").replace(/"/g, '""') + '"',
    '"' + (c.workStatus || "").replace(/"/g, '""') + '"',
    '"' + (c.jobInfo || "").replace(/"/g, '""') + '"',
    c.asianExperience || "",
    '"' + (c.cryptoView || "").replace(/"/g, '""') + '"',
    c.workStart || "",
    c.workEnd || "",
    '"' + (c.hobbies || "").replace(/"/g, '""') + '"',
    '"' + (c.appearance || "").replace(/"/g, '""') + '"',
    c.contactApp || "",
    '"' + (c.contactHandle || "").replace(/"/g, '""') + '"',
    c.sourceApp || "",
    c.contacted ? "1" : "0",
    c.rating || 0,
    '"' + (c.notes || "").replace(/"/g, '""') + '"',
  ].join(","));

  const csv = header.join(",") + "\n" + rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "og_clients.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

exportBtn.addEventListener("click", exportCSV);

/* ---------------------------------------------------
   INITIAL LOAD
---------------------------------------------------- */
saveAll();
renderTable();
updateLastSaved();

</script>
